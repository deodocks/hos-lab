<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜¨ë„ì— ë”°ë¥¸ ê¸°ì²´ì˜ ë¶€í”¼ ë³€í™” ì‹œë®¬ë ˆì´ì…˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f5f7fb;
      color: #222;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .sim-root {
      width: 100%;
      max-width: 1100px;
      padding: 16px;
    }

    h1 {
      font-size: 1.5rem;
      margin: 0 0 8px;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 12px;
    }

    .sim-layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ë°ìŠ¤í¬í†±: í­ ë„“ì„ ë•Œ */
    @media (min-width: 900px) {
      .sim-layout {
        flex-direction: row;
        align-items: stretch;
      }
    }

    /* ëª¨ë°”ì¼ ê°€ë¡œ ëª¨ë“œ: PCì²˜ëŸ¼ ê°€ë¡œ ë°°ì¹˜ + ì „ì²´ ì¶•ì†Œ */
    @media (orientation: landscape) and (max-width: 899px) {
      body {
        align-items: flex-start;
      }
      .sim-root {
        padding: 8px;
        transform: scale(0.9);          /* ì „ì²´ë¥¼ ì‚´ì§ ì¤„ì—¬ì„œ í•œ í™”ë©´ì— */
        transform-origin: top left;
      }
      .sim-layout {
        flex-direction: row;
        align-items: stretch;
      }
      .visual-panel {
        flex: 1.1;
      }
      .slider-panel {
        flex: 0 0 90px;
      }
      .control-panel {
        flex: 1.4;
      }
      h1 {
        font-size: 1.3rem;
      }
      .subtitle {
        font-size: 0.8rem;
      }
    }

    .visual-panel {
      position: relative;
      flex: 1.3;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 18px;
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
      min-height: 330px;
      overflow: hidden;
    }

    .broken-overlay {
      position: absolute;
      inset: 10px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ffb3b3;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 1.0rem;
      color: #c0392b;
      font-weight: 600;
      padding: 12px;
      z-index: 10;
    }

    .cylinder-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 100%;
      min-height: 310px;
    }

    .volume-cylinder-row {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 12px;
      margin-top: 4px;
    }

    .scale-label-item {
      position: absolute;
      left: 0;
      white-space: nowrap;
    }

    /* ì‹¤ë¦°ë” */
    .mass-cylinder {
      position: relative;
      width: 120px;
      height: 260px;
      border-radius: 0 0 10px 10px;
      border-left: 3px solid #555;
      border-right: 3px solid #555;
      border-bottom: 3px solid #555;
      background: rgba(255, 255, 255, 0.2);
      overflow: visible;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    .volume-ticks-right {
      position: absolute;
      left: 100%;
      margin-left: -2px;
      bottom: 4px;
      height: 210px;
      width: 18px;
    }

    .cylinder-scale-label {
      position: absolute;
      left: 100%;
      margin-left: 18px;
      bottom: 4px;
      height: 210px;
      width: 60px;
      font-size: 0.78rem;
      color: #555;
      pointer-events: none;
    }

    .vol-tick {
      position: absolute;
      height: 1px;
      background: #777;
      right: 0;
      width: 8px;
    }

    .vol-tick.major {
      height: 2px;
      background: #333;
      width: 14px;
    }

    .volume-ticks-right .vol-tick {
      left: 0;
      right: auto;
    }

    /* ê¸°ì²´ ì˜ì—­ */
    .gas {
      position: absolute;
      left: 4px;
      right: 4px;
      bottom: 4px;
      height: 120px;
      background: rgba(173, 216, 230, 0.12);
      border-radius: 10px 10px 6px 6px;
      overflow: hidden;
      transition: height 0.7s ease-out;
    }

    .gas.blown {
      animation: gasFly 0.8s ease-out forwards;
    }

    /* ê°œë³„ ì…ì */
    .particle {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffffff, #8ec8ff);
      opacity: 0.9;
      pointer-events: none;
    }

    .piston {
      position: absolute;
      left: 1px;
      right: 1px;
      bottom: 120px;
      height: 14px;
      background: linear-gradient(to bottom, #444, #222);
      border-radius: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.4);
      transition: bottom 0.4s ease;
    }

    .piston.blown {
      animation: pistonFly 0.8s ease-out forwards;
    }

    @keyframes pistonFly {
      0%   { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-180px); opacity: 0; }
    }

    @keyframes gasFly {
      0%   { transform: translateY(0); opacity: 0.9; }
      100% { transform: translateY(-220px); opacity: 0; }
    }

    /* ì˜¨ë„ ì„¼ì„œ */
    .temp-sensor {
      position: absolute;
      right: -90px;
      bottom: 30px;
      width: 170px;
      height: 150px;
      pointer-events: none;
    }

    .sensor-wire {
      position: absolute;
      left: 16px;
      bottom: 16px;
      width: 2px;
      height: 110px;
      background: #777;
    }

    .sensor-tip {
      position: absolute;
      left: 16px;
      transform: translateX(-50%);
      bottom: 8px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffecec, #ff6666);
      border: 2px solid #ffffff;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
    }

    .sensor-wire-out {
      position: absolute;
      left: 16px;
      bottom: 124px;
      width: 120px;
      height: 2px;
      background: #777;
    }

    .sensor-display {
      position: absolute;
      left: 140px;
      bottom: 114px;
      width: 80px;
      height: 26px;
      border-radius: 6px;
      background: #1b1f2a;
      border: 1px solid #4cd964;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: #a3ffb3;
      box-shadow: 0 0 4px rgba(0,0,0,0.35);
      white-space: nowrap;
    }

    /* ì—´ì› */
    .heater-row {
      margin-top: 16px;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: flex-end;
    }

    .heater {
      position: relative;
      width: 130px;
      height: 90px;
    }

    .ice-bucket,
    .burner {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      opacity: 0; /* ì´ˆê¸°ì—ëŠ” ì•ˆ ë³´ì´ê²Œ */
      transition: opacity 0.25s ease, transform 0.25s ease;
    }

    /* ì–¼ìŒí†µ (ì¡°ê°ì–¼ìŒ ë²„ì „) */
    .ice-bucket {
      width: 90px;
      height: 46px;
      background: linear-gradient(to bottom, #c9e3ff 0%, #a9c9eb 60%, #8fb4dd 100%);
      border-radius: 0 0 20px 20px;
      border: 2px solid #5d86b0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    .ice-bucket::before {
      content: "";
      position: absolute;
      left: -4px;
      right: -4px;
      top: -11px;
      height: 18px;
      border-radius: 18px;
      border: 2px solid #5d86b0;
      background: linear-gradient(to bottom, #f8fbff 0%, #d4e6ff 100%);
    }

    .ice-bucket::after {
      content: "";
      position: absolute;
      left: 6px;
      right: 6px;
      top: 6px;
      height: 16px;
      border-radius: 10px;
      background:
        linear-gradient(135deg, rgba(255,255,255,0.9), rgba(220,238,255,0.2)),
        radial-gradient(circle at 20% 20%, rgba(255,255,255,0.8), rgba(255,255,255,0));
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .ice-cubes {
      position: absolute;
      left: 6px;
      right: 6px;
      bottom: 6px;
      top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: flex-end;
      justify-content: center;
      pointer-events: none;
    }

    .ice-cube {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      background:
        linear-gradient(145deg, #ffffff, #d4ecff 45%, #a9cdef 100%);
      border: 1px solid #9ec7e8;
      box-shadow:
        0 0 3px rgba(255,255,255,0.8) inset,
        0 1px 2px rgba(0,0,0,0.15);
    }

    .ice-cube:nth-child(2n) { transform: translateY(-2px); }
    .ice-cube:nth-child(3n) { transform: translateY(1px); }

    .burner {
      width: 48px;
      height: 70px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
    }

    .burner-base {
      width: 56px;
      height: 16px;
      background: #555;
      border-radius: 10px;
      box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
    }

    .flame {
      width: 30px;
      height: 44px;
      position: relative;
      margin-bottom: 4px;
      border-radius: 50%;
      background: radial-gradient(circle at 50% 0,
        #fff6b7 0%,
        #ffb347 40%,
        #e67e22 65%,
        #c0392b 90%);
      animation: flameFlicker 0.22s infinite alternate;
    }

    .flame::before {
      content: "";
      position: absolute;
      left: 8px;
      right: 8px;
      bottom: 6px;
      top: 6px;
      border-radius: 50%;
      background: radial-gradient(circle at 50% 0,
        #ffffff 0%,
        #fff6b7 55%,
        rgba(0,0,0,0) 100%);
      opacity: 0.9;
    }

    .flame::after {
      content: "";
      position: absolute;
      left: -8px;
      right: -8px;
      bottom: 0;
      height: 16px;
      border-radius: 50%;
      background: radial-gradient(circle,
        rgba(255, 200, 120, 0.7),
        rgba(255, 200, 120, 0));
      opacity: 0.8;
    }

    @keyframes flameFlicker {
      0%   { transform: scaleY(0.9) translateY(1px); }
      50%  { transform: scaleY(1.05) translateY(-1px); }
      100% { transform: scaleY(1.15) translateY(-2px); }
    }

    /* ìŠ¬ë¼ì´ë” */
    .slider-panel {
      flex: 0 0 110px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .heat-track-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      margin-top: 12px;
    }

    .heat-label {
      font-size: 0.8rem;
      color: #555;
    }

    .heat-track {
      position: relative;
      width: 20px;
      height: 210px;
      border-radius: 999px;
      background: linear-gradient(to bottom, #ffdddd, #f1f1f1 50%, #ddeeff);
      border: 1px solid #bbbbbb;
      box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.15);
      touch-action: none;
    }

    .heat-handle {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 20px;
      border-radius: 999px;
      background: #ffffff;
      border: 2px solid #4c6fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      touch-action: none;
    }

    /* ì˜¤ë¥¸ìª½ íŒ¨ë„ */
    .control-panel {
      flex: 1.4;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px;
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
    }

    .section-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.95rem;
    }

    .temp-summary {
      padding: 8px 10px;
      border-radius: 10px;
      background: #f7f9ff;
      border: 1px solid #dde4ff;
      font-size: 0.9rem;
    }

    .temp-main-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }

    .temp-main-row strong {
      font-size: 1.05rem;
    }

    .info-box {
      padding: 8px 10px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px dashed #ccd3e0;
      font-size: 0.8rem;
      line-height: 1.4;
    }

    .info-box code {
      background: #eef1ff;
      padding: 1px 4px;
      border-radius: 4px;
      font-size: 0.75rem;
    }

    .data-panel {
      margin-top: 4px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #f7f9ff;
      border: 1px solid #dde4ff;
    }

    .btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      background: #e3ebff;
      color: #2c3e70;
      transition: background 0.15s ease, transform 0.1s ease;
      touch-action: manipulation;
    }

    .btn:active { transform: scale(0.97); }

    .btn-primary {
      background: #4c6fff;
      color: #fff;
    }

    .btn-primary:active {
      background: #3b55d1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 0.8rem;
    }

    th, td {
      border: 1px solid #ccd3e0;
      padding: 4px 6px;
      text-align: center;
    }

    th {
      background: #e9efff;
      font-weight: 600;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 0.75rem;
      color: #777;
      text-align: right;
    }

    .particle-controls {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="sim-root">
    <h1>ì˜¨ë„ì— ë”°ë¥¸ ê¸°ì²´ì˜ ë¶€í”¼ ë³€í™” ì‹œë®¬ë ˆì´ì…˜</h1>
    <div class="subtitle">
      (ì••ë ¥ ì¼ì •, ê¸°ì²´ì˜ ì–‘ ì¼ì • â†’ ìƒ¤ë¥¼ì˜ ë²•ì¹™: <strong>V âˆ T(K)</strong>)
    </div>

    <div class="sim-layout">
      <!-- ì™¼ìª½: ì‹œê°í™” -->
      <div class="visual-panel">
        <div id="brokenOverlay" class="broken-overlay">
          ì‹¤í—˜ ë¶ˆê°€ ìƒíƒœì…ë‹ˆë‹¤.<br />
          ì‹¤í—˜ ì´ˆê¸°í™”ë¥¼ ëˆŒëŸ¬ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.
        </div>

        <div class="cylinder-wrapper">
          <div class="volume-cylinder-row">
            <div class="mass-cylinder">
              <div class="gas"></div>
              <div class="piston" id="piston"></div>

              <!-- ì˜¨ë„ ì„¼ì„œ -->
              <div class="temp-sensor">
                <div class="sensor-wire"></div>
                <div class="sensor-tip"></div>
                <div class="sensor-wire-out"></div>
                <div class="sensor-display">
                  <span id="sensorTempLabel">20.0 â„ƒ</span>
                </div>
              </div>

              <!-- ë¶€í”¼ ëˆˆê¸ˆ -->
              <div class="volume-ticks-right volume-ticks"></div>
              <div class="cylinder-scale-label" id="volumeLabelRight"></div>
            </div>
          </div>

          <!-- ì—´ì› -->
          <div class="heater-row">
            <div class="heater">
              <div class="ice-bucket" id="iceScene">
                <div class="ice-cubes">
                  <div class="ice-cube"></div>
                  <div class="ice-cube"></div>
                  <div class="ice-cube"></div>
                  <div class="ice-cube"></div>
                  <div class="ice-cube"></div>
                  <div class="ice-cube"></div>
                </div>
              </div>
              <div class="burner" id="fireScene">
                <div class="flame"></div>
                <div class="burner-base"></div>
              </div>
            </div>
          </div>

          <!-- ì…ì ìš´ë™ í† ê¸€ & ì¶©ëŒ íšŸìˆ˜ -->
          <div class="particle-controls">
            <button id="toggleParticlesBtn" class="btn">
              ì…ì ìš´ë™ ë³´ê¸°: OFF
            </button>
            <span>
              ì¶©ëŒ íšŸìˆ˜:
              <strong id="collisionCountLabel">0 íšŒ/s</strong>
            </span>
          </div>
        </div>
      </div>

      <!-- ê°€ìš´ë°: ìŠ¬ë¼ì´ë” -->
      <div class="slider-panel">
        <div class="heat-track-wrapper">
          <div class="heat-label">ê°€ì—´ ğŸ”¥</div>
          <div class="heat-track" id="heatTrack">
            <div class="heat-handle" id="heatHandle"></div>
          </div>
          <div class="heat-label">ëƒ‰ê° â„ï¸</div>
          <button id="resetHeatBtn" class="btn" style="margin-top:6px;">
            ì—´ì› ì´ˆê¸°í™”
          </button>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½: ì„¤ëª… + ë°ì´í„° -->
      <div class="control-panel">
        <div class="temp-summary">
          <div class="section-title">1. í˜„ì¬ ìƒíƒœ</div>
          <div class="temp-main-row">
            <div>
              ì˜¨ë„:
              <strong>
                <span id="tempCLabel">20.0</span> â„ƒ
                (<span id="tempKLabel">293.2</span> K)
              </strong>
            </div>
            <div>
              ë¶€í”¼:
              <strong><span id="volumeLabelValue">50.0</span> mL</strong>
            </div>
          </div>
        </div>

        <div class="info-box">
          <div class="section-title">2. ì´ë¡ ê³¼ ì—°ê²°í•˜ê¸°</div>
          <div>
            ì´ ì‹œë®¬ë ˆì´ì…˜ì—ì„œëŠ” <strong>ì••ë ¥(1 atm)ê³¼ ê¸°ì²´ì˜ ì–‘(n)ì„ ì¼ì •</strong>í•˜ê²Œ ë‘ê³ ,
            ì˜¨ë„ë§Œ ë°”ê¾¸ì—ˆì„ ë•Œ <strong>ë¶€í”¼ê°€ ì–´ë–»ê²Œ ë³€í•˜ëŠ”ì§€</strong> ê´€ì°°í•©ë‹ˆë‹¤.
          </div>
          <div style="margin-top: 4px;">
            ì„­ì”¨ ì˜¨ë„ <code>t(â„ƒ)</code>ë¥¼ ì ˆëŒ€ì˜¨ë„
            <code>T(K) = t + 273.15</code>ë¡œ ë°”ê¾¸ì–´ ì‚¬ìš©í•˜ë©´,
            <code>V âˆ T(K)</code> ì´ë¯€ë¡œ <code>V = k Ã— T(K)</code> ê¼´ì˜ ê´€ê³„ë¥¼ ê°€ì§‘ë‹ˆë‹¤.
          </div>
          <div style="margin-top: 4px;">
            ì˜¤ë¥¸ìª½ ëˆˆê¸ˆê³¼ ìˆ˜ì¹˜ë¥¼ í•¨ê»˜ ë³´ë©° ì˜¨ë„ì™€ ë¶€í”¼ì˜ ë¹„ë¡€ ê´€ê³„ë¥¼ ì¶”ë¡ í•´ ë³´ì„¸ìš”.
          </div>
        </div>

        <div class="data-panel">
          <div class="section-title">3. ì¸¡ì •ê°’ ê¸°ë¡í•˜ê¸°</div>
          <div style="font-size: 0.8rem; margin-bottom: 4px;">
            ì›í•˜ëŠ” ì˜¨ë„ì—ì„œ ì¡°ì ˆ ë§‰ëŒ€ë¥¼ ì›€ì§ì—¬ ìƒíƒœë¥¼ ë§ì¶˜ ë’¤,
            <strong>í˜„ì¬ ìƒíƒœ ê¸°ë¡í•˜ê¸°</strong>ë¥¼ ëˆŒëŸ¬ ì˜¨ë„ì™€ ë¶€í”¼ ë°ì´í„°ë¥¼ í‘œë¡œ ê¸°ë¡í•´ ë³´ì„¸ìš”.
          </div>
          <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:4px;">
            <button id="addDataBtn" class="btn btn-primary">
              í˜„ì¬ ìƒíƒœ ê¸°ë¡í•˜ê¸°
            </button>
            <button id="clearDataBtn" class="btn">
              ê¸°ë¡ ì´ˆê¸°í™”
            </button>
            <button id="experimentResetBtn" class="btn">
              ì‹¤í—˜ ì´ˆê¸°í™”
            </button>
          </div>
          <table id="dataTable">
            <thead>
              <tr>
                <th>ë²ˆí˜¸</th>
                <th>ì˜¨ë„ t (â„ƒ)</th>
                <th>ì ˆëŒ€ì˜¨ë„ T (K)</th>
                <th>ë¶€í”¼ V (mL)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="footer-note">
          (í™”ë©´ì´ ë„ˆë¬´ ì‘ìœ¼ë©´ íœ´ëŒ€í°ì„ ê°€ë¡œ ëª¨ë“œë¡œ ëŒë ¤ì„œ ë³´ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤.)
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const tempCLabel = document.getElementById("tempCLabel");
      const tempKLabel = document.getElementById("tempKLabel");
      const volumeLabelValue = document.getElementById("volumeLabelValue");
      const sensorTempLabel = document.getElementById("sensorTempLabel");

      const gasEl = document.querySelector(".gas");
      const pistonEl = document.getElementById("piston");
      const tempSensorEl = document.querySelector(".temp-sensor");

      const heatTrack = document.getElementById("heatTrack");
      const heatHandle = document.getElementById("heatHandle");
      const fireScene = document.getElementById("fireScene");
      const iceScene = document.getElementById("iceScene");
      const resetHeatBtn = document.getElementById("resetHeatBtn");

      const addDataBtn = document.getElementById("addDataBtn");
      const clearDataBtn = document.getElementById("clearDataBtn");
      const experimentResetBtn = document.getElementById("experimentResetBtn");
      const dataBody = document.querySelector("#dataTable tbody");

      const volumeTicks = document.querySelector(".volume-ticks-right");
      const volumeLabelRight = document.getElementById("volumeLabelRight");

      const brokenOverlay = document.getElementById("brokenOverlay");

      const toggleParticlesBtn = document.getElementById("toggleParticlesBtn");
      const collisionCountLabel = document.getElementById("collisionCountLabel");

      // ê¸°ì¤€ê°’ (ê³µê¸°, ì´ìƒê¸°ì²´ ê°€ì •)
      const T_ENV = 293.15;       // ì£¼ë³€ ì˜¨ë„ 20 â„ƒ
      const T0 = 293.15;          // ê¸°ì¤€ 20 â„ƒ
      const V0 = 50.0;            // 20 â„ƒì¼ ë•Œ 50 mL
      const V_MAX = 100.0;        // ëˆˆê¸ˆ ìµœëŒ€(í‘œê¸°ìš©)
      const GAS_RANGE = 210;      // 0~100 mL â†’ 0~210 px
      const MIN_VISIBLE_GAS = 4;

      // ê°€ì—´/ëƒ‰ê° íŒŒë¼ë¯¸í„°
      const HEAT_RATE = 25;       // K/s (power=1)
      const COOL_RATE = 25;       // K/s (cool)
      const TAU_ENV  = 25;        // s, ì—´ì› 0ì¼ ë•Œ ì£¼ë³€ìœ¼ë¡œ ë³µê·€

      // ë¶„ì(ì…ì) ì„¤ì •
      const NUM_PARTICLES = 40;
      const PARTICLE_SIZE = 6;
      let particles = [];

      // ì¶©ëŒ ê³„ì‚°
      let showParticles = false;  // ì´ˆê¸°ì—ëŠ” OFF
      let collisionsAccum = 0;
      let timeAccum = 0;
      let collisionsPerSecond = 0;

      // ìƒíƒœ
      let state = { tempC: 20.0, tempK: T_ENV, volume: V0 };
      let currentTempK = T0;
      let heatPower = 0;          // -1 ~ 1
      let experimentBroken = false;

      let runIndex = 0;

      /* ë¶€í”¼ ëˆˆê¸ˆ */
      function buildVolumeTicksAndLabels() {
        volumeTicks.innerHTML = "";
        const h = GAS_RANGE;

        for (let v = 0; v <= 100; v += 5) {
          const bottom = (v / 100) * h;
          const tick = document.createElement("div");
          tick.className = "vol-tick" + (v % 25 === 0 ? " major" : "");
          tick.style.bottom = bottom + "px";
          volumeTicks.appendChild(tick);
        }

        const majors = [0, 25, 50, 75, 100];
        volumeLabelRight.innerHTML = "";
        majors.forEach(v => {
          const bottom = (v / 100) * h;
          const span = document.createElement("span");
          span.className = "scale-label-item";
          span.textContent = v + " mL";
          span.style.bottom = bottom + "px";
          volumeLabelRight.appendChild(span);
        });
      }
      buildVolumeTicksAndLabels();

      /* ì…ì ê´€ë ¨ */
      function clearParticles() {
        particles.forEach(p => p.el.remove());
        particles = [];
      }

      function createParticles() {
        clearParticles();
        if (!showParticles) return;

        const w = gasEl.clientWidth || 100;
        const h = gasEl.clientHeight || 80;

        for (let i = 0; i < NUM_PARTICLES; i++) {
          const el = document.createElement("div");
          el.className = "particle";
          gasEl.appendChild(el);

          const x = Math.random() * (w - PARTICLE_SIZE);
          const y = Math.random() * (h - PARTICLE_SIZE);
          const angle = Math.random() * Math.PI * 2;
          const baseSpeed = 35 + Math.random() * 35; // px/s
          const vx = baseSpeed * Math.cos(angle);
          const vy = baseSpeed * Math.sin(angle);

          particles.push({ x, y, vx, vy, el });
          el.style.left = x + "px";
          el.style.bottom = y + "px";
        }
      }

      function updateParticles(dt) {
        if (!showParticles || particles.length === 0) return;

        const w = gasEl.clientWidth || 100;
        const h = gasEl.clientHeight || 80;

        // ì†ë„ ê³„ìˆ˜: T/T0 (ìµœëŒ€ 3ë°°), 0K ê·¼ì²˜ì—ì„œëŠ” 0
        let factor = currentTempK / T0;
        if (currentTempK < 1) factor = 0;
        factor = Math.min(factor, 3);

        let collisionsThisFrame = 0;

        particles.forEach(p => {
          let vx = p.vx * factor;
          let vy = p.vy * factor;

          let x = p.x + vx * dt;
          let y = p.y + vy * dt;

          if (x < 0) { x = 0; p.vx = Math.abs(p.vx); collisionsThisFrame++; }
          if (x > w - PARTICLE_SIZE) {
            x = w - PARTICLE_SIZE;
            p.vx = -Math.abs(p.vx);
            collisionsThisFrame++;
          }
          if (y < 0) { y = 0; p.vy = Math.abs(p.vy); collisionsThisFrame++; }
          if (y > h - PARTICLE_SIZE) {
            y = h - PARTICLE_SIZE;
            p.vy = -Math.abs(p.vy);
            collisionsThisFrame++;
          }

          p.x = x;
          p.y = y;
          p.el.style.left = x + "px";
          p.el.style.bottom = y + "px";
        });

        collisionsAccum += collisionsThisFrame;
      }

      /* ì˜¨ë„ â†’ ë¶€í”¼/í‘œì‹œ ê°±ì‹  */
      function applyCurrentTemperature() {
        if (currentTempK < 0.001) currentTempK = 0.001;

        const tempK = currentTempK;
        const tempC = tempK - 273.15;
        let volume = V0 * (tempK / T0);

        if (volume < 0) volume = 0;

        state.tempC = tempC;
        state.tempK = tempK;
        state.volume = volume;

        tempCLabel.textContent = tempC.toFixed(1);
        tempKLabel.textContent = tempK.toFixed(1);
        volumeLabelValue.textContent = volume.toFixed(1);
        sensorTempLabel.textContent = tempC.toFixed(1) + " â„ƒ";

        // ë¶€í”¼ â†’ ê¸°ì²´ ë†’ì´
        let vNorm = volume / V_MAX;
        if (vNorm < 0) vNorm = 0;
        let gasHeight = vNorm * GAS_RANGE;
        if (gasHeight < MIN_VISIBLE_GAS && volume > 0) gasHeight = MIN_VISIBLE_GAS;

        const gasBottom = 4;

        // ì˜¨ë„ì„¼ì„œê°€ í•­ìƒ ê¸°ì²´ ì•ˆì— ìˆë„ë¡ ì„¼ì„œ ë°•ìŠ¤ë¥¼ ê°™ì´ ì´ë™
        const targetTipY = gasBottom + gasHeight * 0.5;
        const TIP_OFFSET = 8; // temp-sensor ì•ˆì—ì„œ tip bottom
        tempSensorEl.style.bottom = (targetTipY - TIP_OFFSET) + "px";

        gasEl.style.height = gasHeight + "px";

        const pistonBottom = gasBottom + gasHeight;
        pistonEl.style.bottom = pistonBottom + "px";

        const pistonHeight = 14;
        const CYL_HEIGHT = 260;
        const pistonTop = pistonBottom + pistonHeight;
        if (!experimentBroken && pistonTop > CYL_HEIGHT) {
          triggerExplosion();
        }
      }

      function triggerExplosion() {
        if (experimentBroken) return;
        experimentBroken = true;

        heatPower = 0;
        updateHeatUIFromPower(heatPower);

        pistonEl.classList.add("blown");
        gasEl.classList.add("blown");

        brokenOverlay.style.display = "flex";
      }

      /* ì—´ì› ì „ë ¥â†’ UI */
      function updateHeatUIFromPower(power) {
        const rect = heatTrack.getBoundingClientRect();
        const trackHeight = rect.height || 210;
        const handleHeight = heatHandle.offsetHeight || 20;

        const level = (power + 1) / 2; // 0~1
        const yCenter = (1 - level) * trackHeight;
        let top = yCenter - handleHeight / 2;
        if (top < 0) top = 0;
        if (top > trackHeight - handleHeight) top = trackHeight - handleHeight;
        heatHandle.style.top = top + "px";

        const fireIntensity = Math.max(0, power);
        const iceIntensity  = Math.max(0, -power);
        fireScene.style.opacity = fireIntensity;
        iceScene.style.opacity  = iceIntensity;

        const flameScale = 0.35 + 0.65 * fireIntensity;
        fireScene.style.transform =
          "translateX(-50%) scaleY(" + flameScale.toFixed(2) + ")";

        const iceScale = 0.7 + 0.3 * iceIntensity;
        iceScene.style.transform =
          "translateX(-50%) scale(" + iceScale.toFixed(2) + ")";
      }

      /* ìŠ¬ë¼ì´ë” â†’ heatPower */
      let dragging = false;

      function handleHeatPointer(clientY) {
        if (experimentBroken) return;
        const rect = heatTrack.getBoundingClientRect();
        let y = clientY - rect.top;
        if (y < 0) y = 0;
        if (y > rect.height) y = rect.height;

        const level = 1 - y / rect.height; // ìœ„ 1, ì•„ë˜ 0
        heatPower = 2 * level - 1;         // -1~1
        if (heatPower > 1) heatPower = 1;
        if (heatPower < -1) heatPower = -1;
        updateHeatUIFromPower(heatPower);
      }

      if (window.PointerEvent) {
        heatHandle.addEventListener("pointerdown", e => {
          if (experimentBroken) return;
          dragging = true;
          heatHandle.setPointerCapture(e.pointerId);
          handleHeatPointer(e.clientY);
        });
        heatHandle.addEventListener("pointermove", e => {
          if (!dragging) return;
          handleHeatPointer(e.clientY);
        });
        heatHandle.addEventListener("pointerup", e => {
          dragging = false;
          heatHandle.releasePointerCapture(e.pointerId);
        });
        heatHandle.addEventListener("pointercancel", () => {
          dragging = false;
        });

        heatTrack.addEventListener("pointerdown", e => {
          if (experimentBroken) return;
          dragging = true;
          handleHeatPointer(e.clientY);
        });
        heatTrack.addEventListener("pointermove", e => {
          if (!dragging) return;
          handleHeatPointer(e.clientY);
        });
        heatTrack.addEventListener("pointerup", () => {
          dragging = false;
        });
        heatTrack.addEventListener("pointercancel", () => {
          dragging = false;
        });
      } else {
        // ë§ˆìš°ìŠ¤/í„°ì¹˜ í´ë°±
        heatHandle.addEventListener("mousedown", e => {
          if (experimentBroken) return;
          dragging = true;
          handleHeatPointer(e.clientY);
        });
        document.addEventListener("mousemove", e => {
          if (!dragging) return;
          handleHeatPointer(e.clientY);
        });
        document.addEventListener("mouseup", () => {
          dragging = false;
        });

        heatHandle.addEventListener("touchstart", e => {
          if (experimentBroken) return;
          dragging = true;
          const t = e.touches[0];
          handleHeatPointer(t.clientY);
          e.preventDefault();
        });
        document.addEventListener("touchmove", e => {
          if (!dragging) return;
          const t = e.touches[0];
          handleHeatPointer(t.clientY);
          e.preventDefault();
        });
        document.addEventListener("touchend", () => {
          dragging = false;
        });
      }

      /* ì—´ì› ì´ˆê¸°í™” */
      resetHeatBtn.addEventListener("click", () => {
        if (experimentBroken) return;
        heatPower = 0;
        updateHeatUIFromPower(heatPower);
      });

      /* ì…ì ON/OFF í† ê¸€ */
      toggleParticlesBtn.addEventListener("click", () => {
        showParticles = !showParticles;
        toggleParticlesBtn.textContent =
          "ì…ì ìš´ë™ ë³´ê¸°: " + (showParticles ? "ON" : "OFF");

        if (showParticles) {
          createParticles();
        } else {
          clearParticles();
          collisionsAccum = 0;
          timeAccum = 0;
          collisionsPerSecond = 0;
          collisionCountLabel.textContent = "0 íšŒ/s";
        }
      });

      /* ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ */
      let lastTime = null;
      function animationLoop(timestamp) {
        if (!lastTime) lastTime = timestamp;
        const dt = (timestamp - lastTime) / 1000;
        lastTime = timestamp;

        if (!experimentBroken) {
          if (heatPower > 0) {
            currentTempK += HEAT_RATE * heatPower * dt;
          } else if (heatPower < 0) {
            const factor = currentTempK / 300;
            currentTempK += COOL_RATE * heatPower * factor * dt;
            if (currentTempK < 0.001) currentTempK = 0.001;
          } else {
            const dT_env = (T_ENV - currentTempK) / TAU_ENV;
            currentTempK += dT_env * dt;
          }

          applyCurrentTemperature();
          updateParticles(dt);

          if (showParticles) {
            timeAccum += dt;
            if (timeAccum >= 0.2) {
              collisionsPerSecond = collisionsAccum / timeAccum;
              collisionsAccum = 0;
              timeAccum = 0;
              collisionCountLabel.textContent =
                collisionsPerSecond.toFixed(0) + " íšŒ/s";
            }
          }
        }

        requestAnimationFrame(animationLoop);
      }

      /* ë°ì´í„° ê¸°ë¡ */
      function addDataRow() {
        if (experimentBroken) return;
        runIndex++;
        const tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + runIndex + "</td>" +
          "<td>" + state.tempC.toFixed(1) + "</td>" +
          "<td>" + state.tempK.toFixed(2) + "</td>" +
          "<td>" + state.volume.toFixed(1) + "</td>";
        dataBody.appendChild(tr);
      }
      addDataBtn.addEventListener("click", addDataRow);

      function clearData() {
        if (experimentBroken) return;
        dataBody.innerHTML = "";
        runIndex = 0;
      }
      clearDataBtn.addEventListener("click", clearData);

      /* ì‹¤í—˜ ì „ì²´ ì´ˆê¸°í™” */
      function resetExperiment() {
        experimentBroken = false;
        brokenOverlay.style.display = "none";

        gasEl.classList.remove("blown");
        pistonEl.classList.remove("blown");
        gasEl.style.transform = "";
        pistonEl.style.transform = "";

        currentTempK = T_ENV;
        heatPower = 0;
        applyCurrentTemperature();
        updateHeatUIFromPower(heatPower);

        collisionsAccum = 0;
        timeAccum = 0;
        collisionsPerSecond = 0;
        collisionCountLabel.textContent = "0 íšŒ/s";

        if (showParticles) {
          createParticles();
        } else {
          clearParticles();
        }

        dataBody.innerHTML = "";
        runIndex = 0;
      }

      experimentResetBtn.addEventListener("click", resetExperiment);

      // ì´ˆê¸° ìƒíƒœ
      resetExperiment();
      requestAnimationFrame(animationLoop);
    });
  </script>
</body>
</html>
