<script>
  // 부피 범위 (mL)
  const V_MIN = 10;
  const V_MAX = 60;
  const P_AT_VMAX = 100;
  const PV_CONST = V_MAX * P_AT_VMAX; // 6000

  const piston = document.getElementById("piston");
  const plungerBody = document.getElementById("plungerBody");
  const plungerHandle = document.getElementById("plungerHandle");
  const dragArea = document.getElementById("dragArea");
  const pressureText = document.getElementById("pressureText");
  const pressureDisplay = document.getElementById("pressureDisplay");
  const volumeDisplay = document.getElementById("volumeDisplay");
  const scaleLines = document.getElementById("scaleLines");
  const scaleText = document.getElementById("scaleText");

  // 플런저 x 위치 범위 (SVG 좌표)
  const MIN_X = 305;   // 10 mL 위치
  const MAX_X = 545;   // 60 mL 위치 (원래 모양)
  const REST_X = MAX_X; // 손을 떼면 돌아갈 위치

  const PISTON_WIDTH = 26;
  const ROD_WIDTH = 260;  // 막대 길이 고정 (길게)

  let currentX = MAX_X;
  let isDragging = false;

  // 되돌아가는 애니메이션용
  let returnAnimationId = null;

  function xToVolume(x) {
    const ratio = (x - MIN_X) / (MAX_X - MIN_X); // 0~1
    return V_MIN + (V_MAX - V_MIN) * ratio;
  }

  function volumeToX(V) {
    const ratio = (V - V_MIN) / (V_MAX - V_MIN);
    return MIN_X + (MAX_X - MIN_X) * ratio;
  }

  // 눈금: 1 mL마다 짧은 선, 10 mL마다 긴 선
  function createScale() {
    const barrelTop = 82;
    const shortLen = 8;
    const longLen = 14;
    for (let v = V_MIN; v <= V_MAX; v += 1) {
      const x = volumeToX(v);
      const isMajor10 = (v % 10 === 0);
      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", x);
      line.setAttribute("x2", x);
      line.setAttribute("y1", barrelTop);
      line.setAttribute("y2", barrelTop + (isMajor10 ? longLen : shortLen));
      line.setAttribute("stroke", "#555");
      line.setAttribute("stroke-width", isMajor10 ? "1.4" : "1");
      scaleLines.appendChild(line);

      if (isMajor10) {
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", x);
        text.setAttribute("y", barrelTop - 6);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("font-size", "10");
        text.setAttribute("fill", "#333");
        text.textContent = (v === V_MAX) ? `${v} (mL)` : `${v}`;
        scaleText.appendChild(text);
      }
    }
  }

  function updateFromX(x) {
    currentX = Math.max(MIN_X, Math.min(x, MAX_X));

    // 고무패킹 위치
    piston.setAttribute("x", currentX);

    // 막대(몸통)는 고정 길이로, 고무패킹 뒤에 붙어서 같이 이동
    const bodyX = currentX + PISTON_WIDTH;
    plungerBody.setAttribute("x", bodyX);
    plungerBody.setAttribute("width", ROD_WIDTH);

    // 손잡이는 막대 끝에 고정
    plungerHandle.setAttribute("x", bodyX + ROD_WIDTH);

    // 부피·압력 계산 (보일 법칙)
    const V = xToVolume(currentX);
    const P = PV_CONST / V;

    volumeDisplay.textContent = V.toFixed(1);
    pressureDisplay.textContent = P.toFixed(1);
    pressureText.textContent = `${P.toFixed(1)} kPa`;
  }

  // -------------------------
  //  되돌아가는 애니메이션
  // -------------------------
  function stepReturn() {
    const targetX = REST_X;
    const dx = targetX - currentX;

    if (Math.abs(dx) < 0.2) {
      updateFromX(targetX);
      returnAnimationId = null;
      return;
    }

    const newX = currentX + dx * 0.08;
    updateFromX(newX);

    returnAnimationId = requestAnimationFrame(stepReturn);
  }

  function startReturnAnimation() {
    if (returnAnimationId) {
      cancelAnimationFrame(returnAnimationId);
      returnAnimationId = null;
    }
    returnAnimationId = requestAnimationFrame(stepReturn);
  }

  // -------------------------
  //  공통 좌표 추출 함수 (마우스 + 터치)
  // -------------------------
  function getClientX(evt) {
    if (evt.touches && evt.touches.length > 0) {
      return evt.touches[0].clientX;
    }
    if (evt.changedTouches && evt.changedTouches.length > 0) {
      return evt.changedTouches[0].clientX;
    }
    return evt.clientX;
  }

  // -------------------------
  //  드래그 처리
  // -------------------------
  function startDrag(e) {
    e.preventDefault();

    if (returnAnimationId) {
      cancelAnimationFrame(returnAnimationId);
      returnAnimationId = null;
    }
    isDragging = true;

    // 시작하자마자 위치 한번 업데이트 (터치에서도 튀지 않게)
    moveDrag(e);
  }

  function moveDrag(e) {
    if (!isDragging) return;
    e.preventDefault();

    const svg = document.getElementById("scene");
    const rect = svg.getBoundingClientRect();
    const clientX = getClientX(e);
    const mouseX = clientX - rect.left;

    updateFromX(mouseX);
  }

  function endDrag(e) {
    if (!isDragging) return;
    e.preventDefault();
    isDragging = false;

    // 원래 위치(REST_X)와 차이가 있으면, 스르르 되돌아가게
    if (Math.abs(currentX - REST_X) > 0.2) {
      startReturnAnimation();
    }
  }

  // 고무패킹 + 막대 + 손잡이 전체를 드래그 가능하게 (마우스 + 터치)
  [dragArea, piston, plungerBody, plungerHandle].forEach(el => {
    el.addEventListener("mousedown", startDrag);
    el.addEventListener("touchstart", startDrag, { passive: false });
  });

  // 전역에서 움직임/끝 감지 (마우스 + 터치)
  window.addEventListener("mousemove", moveDrag);
  window.addEventListener("mouseup", endDrag);

  window.addEventListener("touchmove", moveDrag, { passive: false });
  window.addEventListener("touchend", endDrag, { passive: false });
  window.addEventListener("touchcancel", endDrag, { passive: false });

  createScale();
  updateFromX(MAX_X);
</script>
