<script>
  // ====== 보일의 법칙 설정 ======
  var V_MIN = 10;
  var V_MAX = 60;
  var P_AT_VMAX = 100;
  var PV_CONST = V_MAX * P_AT_VMAX; // 6000

  var piston = document.getElementById("piston");
  var plungerBody = document.getElementById("plungerBody");
  var plungerHandle = document.getElementById("plungerHandle");
  var dragArea = document.getElementById("dragArea");
  var pressureText = document.getElementById("pressureText");
  var pressureDisplay = document.getElementById("pressureDisplay");
  var volumeDisplay = document.getElementById("volumeDisplay");
  var scaleLines = document.getElementById("scaleLines");
  var scaleText = document.getElementById("scaleText");
  var svg = document.getElementById("scene");

  // 플런저 x 위치 범위 (SVG viewBox 좌표)
  var MIN_X = 305;    // 10 mL 위치
  var MAX_X = 545;    // 60 mL 위치
  var REST_X = MAX_X; // 손을 떼면 돌아갈 위치(60 mL)

  var PISTON_WIDTH = 26;
  var ROD_WIDTH = 260;        // 막대 길이 고정
  var VIEWBOX_WIDTH = 900;    // viewBox="0 0 900 220"
  var VIEWBOX_X = 0;

  var currentX = MAX_X;
  var isDragging = false;
  var activeTouchId = null;   // 어떤 손가락인지 추적
  var returnAnimationId = null;

  // ====== 부피/압력 계산 ======
  function xToVolume(x) {
    var ratio = (x - MIN_X) / (MAX_X - MIN_X); // 0~1
    return V_MIN + (V_MAX - V_MIN) * ratio;
  }

  function volumeToX(V) {
    var ratio = (V - V_MIN) / (V_MAX - V_MIN);
    return MIN_X + (MAX_X - MIN_X) * ratio;
  }

  // 눈금 생성
  function createScale() {
    var barrelTop = 82;
    var shortLen = 8;
    var longLen = 14;

    for (var v = V_MIN; v <= V_MAX; v += 1) {
      var x = volumeToX(v);
      var isMajor10 = (v % 10 === 0);

      var line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", x);
      line.setAttribute("x2", x);
      line.setAttribute("y1", barrelTop);
      line.setAttribute("y2", barrelTop + (isMajor10 ? longLen : shortLen));
      line.setAttribute("stroke", "#555");
      line.setAttribute("stroke-width", isMajor10 ? "1.4" : "1");
      scaleLines.appendChild(line);

      if (isMajor10) {
        var text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", x);
        text.setAttribute("y", barrelTop - 6);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("font-size", "10");
        text.setAttribute("fill", "#333");
        text.textContent = (v === V_MAX) ? (v + " (mL)") : String(v);
        scaleText.appendChild(text);
      }
    }
  }

  // 화면 좌표 → SVG 좌표(x) 변환 (viewBox 기준)
  function getSvgXFromEvent(evt) {
    var rect = svg.getBoundingClientRect();
    var clientX;

    if (evt.touches && evt.touches.length > 0) {
      // 드래그 중이면 activeTouchId와 일치하는 터치 찾기
      if (activeTouchId !== null) {
        for (var i = 0; i < evt.touches.length; i++) {
          if (evt.touches[i].identifier === activeTouchId) {
            clientX = evt.touches[i].clientX;
            break;
          }
        }
        // 손가락을 못 찾으면 현재 위치 유지
        if (typeof clientX === "undefined") {
          return currentX;
        }
      } else {
        clientX = evt.touches[0].clientX;
      }
    } else if (evt.changedTouches && evt.changedTouches.length > 0) {
      clientX = evt.changedTouches[0].clientX;
    } else {
      clientX = evt.clientX;
    }

    var scaleX = VIEWBOX_WIDTH / rect.width;
    var svgX = VIEWBOX_X + (clientX - rect.left) * scaleX;
    return svgX;
  }

  function updateFromX(x) {
    if (x < MIN_X) x = MIN_X;
    if (x > MAX_X) x = MAX_X;
    currentX = x;

    // 고무패킹
    piston.setAttribute("x", currentX);

    // 막대
    var bodyX = currentX + PISTON_WIDTH;
    plungerBody.setAttribute("x", bodyX);
    plungerBody.setAttribute("width", ROD_WIDTH);

    // 손잡이
    plungerHandle.setAttribute("x", bodyX + ROD_WIDTH);

    // 보일 법칙 계산
    var V = xToVolume(currentX);
    var P = PV_CONST / V;

    volumeDisplay.textContent = V.toFixed(1);
    pressureDisplay.textContent = P.toFixed(1);
    pressureText.textContent = P.toFixed(1) + " kPa";
  }

  // ====== 되돌아가는 애니메이션 ======
  function stepReturn() {
    var targetX = REST_X;
    var dx = targetX - currentX;

    if (Math.abs(dx) < 0.2) {
      updateFromX(targetX);
      returnAnimationId = null;
      return;
    }

    var newX = currentX + dx * 0.08; // 부드럽게 근사
    updateFromX(newX);

    returnAnimationId = window.requestAnimationFrame(stepReturn);
  }

  function startReturnAnimation() {
    if (returnAnimationId !== null) {
      window.cancelAnimationFrame(returnAnimationId);
      returnAnimationId = null;
    }
    returnAnimationId = window.requestAnimationFrame(stepReturn);
  }

  // ====== 드래그 처리 (마우스 + 터치) ======
  function startDrag(evt) {
    evt.preventDefault();

    // 복원 애니메이션 중이면 정지
    if (returnAnimationId !== null) {
      window.cancelAnimationFrame(returnAnimationId);
      returnAnimationId = null;
    }

    isDragging = true;
    activeTouchId = null;

    // 터치라면 어떤 손가락인지 기록
    if (evt.touches && evt.touches.length > 0) {
      activeTouchId = evt.touches[0].identifier;
    }

    var svgX = getSvgXFromEvent(evt);
    updateFromX(svgX);
  }

  function moveDrag(evt) {
    if (!isDragging) return;
    evt.preventDefault();

    var svgX = getSvgXFromEvent(evt);
    updateFromX(svgX);
  }

  function endDrag(evt) {
    if (!isDragging) return;
    evt.preventDefault();

    isDragging = false;
    activeTouchId = null;

    // 손을 떼면 원래 위치로 되돌아가게
    if (Math.abs(currentX - REST_X) > 0.2) {
      startReturnAnimation();
    }
  }

  // ====== 이벤트 등록 ======
  function addDragListeners(el) {
    el.addEventListener("mousedown", startDrag, false);
    el.addEventListener("touchstart", startDrag, false);
  }

  addDragListeners(dragArea);
  addDragListeners(piston);
  addDragListeners(plungerBody);
  addDragListeners(plungerHandle);

  // 전역 이동/종료(마우스 + 터치)
  window.addEventListener("mousemove", moveDrag, false);
  window.addEventListener("mouseup", endDrag, false);
  window.addEventListener("touchmove", moveDrag, false);
  window.addEventListener("touchend", endDrag, false);
  window.addEventListener("touchcancel", endDrag, false);

  // ====== 초기 설정 ======
  createScale();
  updateFromX(MAX_X);
</script>
